<!DOCTYPE html>

<html>
<head>
  <title>PsyCloud.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>PsyCloud.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class="highlight"><pre><span class="nv">_ = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;lodash&#39;</span><span class="p">)</span>



<span class="nv">seqalong = </span><span class="nf">(vec) -&gt;</span> <span class="p">[</span><span class="mi">0</span> <span class="p">..</span> <span class="nx">vec</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

<span class="nv">rep = </span><span class="nf">(vec, times) -&gt;</span>
  <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">times</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span>
    <span class="nv">times = </span><span class="p">[</span><span class="nx">times</span><span class="p">]</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">times</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">and</span> <span class="nx">vec</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="nx">times</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
    <span class="k">throw</span> <span class="s">&quot;vec.length must equal times.length or times.length must be 1&quot;</span>
  <span class="k">if</span> <span class="nx">vec</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="nx">times</span><span class="p">.</span><span class="nx">length</span>
    <span class="nv">out = </span><span class="k">for</span> <span class="nx">el</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">vec</span>
      <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="nx">times</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span>
        <span class="nx">el</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">flatten</span><span class="p">(</span><span class="nx">out</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="nv">out = </span><span class="nx">_</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span><span class="nx">times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nf">(n) =&gt;</span> <span class="nx">vec</span><span class="p">)</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">flatten</span><span class="p">(</span><span class="nx">out</span><span class="p">)</span>

<span class="nv">exports.rep = </span><span class="nx">rep</span>
<span class="nv">exports.seqalong = </span><span class="nx">seqalong</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              
<h2>Sampler</h2>

            </div>
            
            <div class="content"><div class="highlight"><pre><span class="nv">exports.Sampler =</span>
<span class="k">class</span> <span class="nx">Sampler</span>

  <span class="vi">@fillBuffer: </span><span class="nf">(items, n) -&gt;</span>
    <span class="nv">buf = </span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">shuffle</span><span class="p">(</span><span class="nx">items</span><span class="p">)</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="nx">n</span><span class="p">])</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">flatten</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>


  <span class="nv">constructor: </span><span class="nf">(@items, buflen=10) -&gt;</span>
    <span class="vi">@buffer = </span><span class="nx">Sampler</span><span class="p">.</span><span class="nx">fillBuffer</span><span class="p">(</span><span class="nx">@items</span><span class="p">,</span> <span class="nx">buflen</span><span class="p">)</span>


  <span class="nv">shuffle: </span><span class="nf">-&gt;</span>
    <span class="nv">idx = </span><span class="nx">_</span><span class="p">.</span><span class="nx">shuffle</span><span class="p">([</span><span class="mi">0</span><span class="p">...</span><span class="nx">@items</span><span class="p">.</span><span class="nx">length</span><span class="p">])</span>
    <span class="nx">@items</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">idx</span>

  <span class="nv">take: </span><span class="nf">(n) -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              
<p>the sampling strategy is <strong>exhaustive</strong>, which means that all items will be sampled once before any item is sampled twice.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="k">if</span> <span class="nx">n</span> <span class="o">&lt;=</span> <span class="nx">@buffer</span><span class="p">.</span><span class="nx">length</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              
<p>if the number of requested items is less than or equal to the size of the buffer, return the next <strong>n</strong> items</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>      <span class="nv">res = </span><span class="nx">_</span><span class="p">.</span><span class="nx">take</span><span class="p">(</span><span class="nx">@buffer</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span>
      <span class="vi">@buffer = </span><span class="nx">_</span><span class="p">.</span><span class="nx">drop</span><span class="p">(</span><span class="nx">@buffer</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span>
      <span class="nx">res</span>
    <span class="k">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              
<p>otherwise, create a new buffer</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>      <span class="nv">buflen = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="nx">@items</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
      <span class="nv">buf = </span><span class="nx">Sampler</span><span class="p">.</span><span class="nx">fillBuffer</span><span class="p">(</span><span class="nx">@items</span><span class="p">,</span> <span class="nx">buflen</span><span class="o">/</span><span class="nx">@items</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              
<p>but place reamining items from previous buffer at head of the new buffer</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>      <span class="vi">@buffer = </span><span class="nx">@buffer</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              
<h2>UniformSampler</h2>

            </div>
            
            <div class="content"><div class="highlight"><pre><span class="nv">exports.UniformSampler =</span>
<span class="k">class</span> <span class="nx">UniformSampler</span> <span class="k">extends</span> <span class="nx">Sampler</span>

  <span class="vi">@validate: </span><span class="nf">(range) -&gt;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">range</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
      <span class="k">throw</span> <span class="s">&quot;range must be an array with two values (min, max)&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nx">range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="k">throw</span> <span class="s">&quot;range[1] must &gt; range[0]&quot;</span>

  <span class="nv">constructor: </span><span class="nf">(@range) -&gt;</span>
    <span class="vi">@interval = </span><span class="nx">@range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">@range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

  <span class="nv">take: </span><span class="nf">(n) -&gt;</span>
    <span class="nv">nums = </span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="nx">@interval</span><span class="p">)</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="nx">n</span><span class="p">])</span>
    <span class="nx">nums</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              
<h2>Factor</h2>

            </div>
            
            <div class="content"><div class="highlight"><pre><span class="nv">exports.Factor =</span>
<span class="k">class</span> <span class="nx">Factor</span> <span class="k">extends</span> <span class="nb">Array</span>

  <span class="vi">@asFactor = </span><span class="nf">(arr) -&gt;</span>  <span class="k">new</span> <span class="nx">Factor</span><span class="p">(</span><span class="nx">arr</span><span class="p">...)</span>

  <span class="nv">constructor: </span><span class="nf">(arr) -&gt;</span>
    <span class="nx">@push</span> <span class="nx">arg</span> <span class="k">for</span> <span class="nx">arg</span> <span class="k">in</span> <span class="nx">arr</span>
    <span class="vi">@levels = </span><span class="nx">_</span><span class="p">.</span><span class="nx">uniq</span><span class="p">(</span><span class="nx">arr</span><span class="p">).</span><span class="nx">sort</span><span class="p">()</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              
<h2>DataTable</h2>

            </div>
            
            <div class="content"><div class="highlight"><pre><span class="nv">exports.DataTable =</span>
<span class="k">class</span> <span class="nx">DataTable</span>

  <span class="nv">show: </span><span class="nf">-&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&quot;DataTable: rows: </span><span class="si">#{</span><span class="nx">@nrow</span><span class="p">()</span><span class="si">}</span><span class="s"> columns: </span><span class="si">#{</span><span class="nx">@ncol</span><span class="p">()</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="nx">@nrow</span><span class="p">()]</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">@record</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span>

  <span class="vi">@build: </span><span class="nf">(vars={ }) -&gt;</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">seal</span><span class="p">(</span><span class="k">new</span> <span class="nx">DataTable</span><span class="p">(</span><span class="nx">vars</span><span class="p">))</span>

  <span class="vi">@expand: </span><span class="nf">(vars={}, unique=true, nreps=1) -&gt;</span>
    <span class="k">if</span> <span class="nx">unique</span>
      <span class="nv">vars = </span><span class="nx">_</span><span class="p">.</span><span class="nx">forOwn</span><span class="p">(</span><span class="nx">vars</span><span class="p">,</span> <span class="nf">(v, k) -&gt;</span> <span class="p">{</span> <span class="nv">k: </span><span class="nx">_</span><span class="p">.</span><span class="nx">unique</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">}</span> <span class="p">)</span>

    <span class="nv">nargs = </span><span class="nx">_</span><span class="p">.</span><span class="nx">size</span><span class="p">(</span><span class="nx">vars</span><span class="p">)</span>
    <span class="nv">nm = </span><span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">vars</span><span class="p">)</span>
    <span class="nv">repfac = </span><span class="mi">1</span>
    <span class="nv">d = </span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">vars</span><span class="p">,</span> <span class="nf">(x) -&gt;</span> <span class="nx">x</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>


    <span class="nv">orep = </span><span class="nx">_</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nf">(x, acc) -&gt;</span> <span class="nx">x</span><span class="o">*</span><span class="nx">acc</span><span class="p">)</span>
    <span class="nv">out = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">vars</span>
      <span class="nv">nx = </span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span>
      <span class="nv">orep = </span><span class="nx">orep</span><span class="o">/</span><span class="nx">nx</span>
      <span class="nv">r1 = </span><span class="nx">rep</span><span class="p">([</span><span class="nx">repfac</span><span class="p">],</span> <span class="nx">nx</span><span class="p">)</span>
      <span class="nv">r2 = </span><span class="nx">rep</span><span class="p">([</span><span class="mi">0</span><span class="p">...</span><span class="nx">nx</span><span class="p">],</span> <span class="nx">r1</span><span class="p">)</span>
      <span class="nv">r3 = </span><span class="nx">rep</span><span class="p">(</span><span class="nx">r2</span><span class="p">,</span> <span class="nx">orep</span><span class="p">)</span>
      <span class="nx">out</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">value</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">r3</span><span class="p">)</span>
      <span class="nv">repfac = </span><span class="nx">repfac</span> <span class="o">*</span> <span class="nx">nx</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              
<p>if (nreps &gt; 1)
 for i in [1..nreps]
   out = _.merge(out,out)</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="k">new</span> <span class="nx">DataTable</span><span class="p">(</span><span class="nx">out</span><span class="p">)</span>

  <span class="nv">constructor: </span><span class="nf">(vars={ }) -&gt;</span>
    <span class="nv">varlen = </span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">vars</span><span class="p">,</span> <span class="nf">(x) -&gt;</span> <span class="nx">x</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
    <span class="nv">samelen = </span><span class="nx">_</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">varlen</span><span class="p">,</span> <span class="nf">(x) -&gt;</span> <span class="nx">x</span> <span class="o">==</span> <span class="nx">varlen</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="o">not</span> <span class="nx">samelen</span>
      <span class="k">throw</span> <span class="s">&quot;arguments to DataTable must all have same length.&quot;</span>

    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">vars</span>
      <span class="k">this</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>

  <span class="nv">subset: </span><span class="nf">(key, filter) -&gt;</span>
    <span class="nv">keep = </span><span class="k">for</span> <span class="nx">val</span> <span class="k">in</span> <span class="k">this</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">filter</span><span class="p">(</span><span class="nx">val</span><span class="p">))</span> <span class="k">then</span> <span class="kc">true</span> <span class="k">else</span> <span class="kc">false</span>
    <span class="nv">out = </span><span class="p">{}</span>

    <span class="k">for</span> <span class="k">own</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="k">this</span>
      <span class="nx">out</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">el</span> <span class="k">for</span> <span class="nx">el</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">value</span> <span class="k">when</span> <span class="nx">keep</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="kc">true</span><span class="p">)</span>

    <span class="k">new</span> <span class="nx">DataTable</span><span class="p">(</span><span class="nx">out</span><span class="p">)</span>

  <span class="nv">nrow: </span><span class="nf">-&gt;</span>
    <span class="nv">lens = </span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="k">for</span> <span class="k">own</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="k">this</span><span class="p">)</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">lens</span><span class="p">)</span>

  <span class="nv">ncol: </span><span class="nf">-&gt;</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">length</span>

  <span class="nv">record: </span><span class="nf">(index) -&gt;</span>
    <span class="nv">rec = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="k">own</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="k">this</span>
      <span class="nx">rec</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
    <span class="nx">rec</span>

  <span class="nv">replicate: </span><span class="nf">(nreps) -&gt;</span>
    <span class="nv">out = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="k">own</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="k">this</span>
      <span class="nx">out</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">flatten</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span><span class="nx">nreps</span><span class="p">,</span> <span class="nf">(n) =&gt;</span> <span class="nx">value</span><span class="p">))</span>
    <span class="k">new</span> <span class="nx">DataTable</span><span class="p">(</span><span class="nx">out</span><span class="p">)</span>

  <span class="nv">bindcol: </span><span class="nf">(name, column) -&gt;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">column</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="nx">@nrow</span><span class="p">())</span>
     <span class="k">throw</span> <span class="s">&quot;new column must be same length as existing DataTable object: column.length is  </span><span class="si">#{</span><span class="nx">column</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="s"> and this.length is  </span><span class="si">#{</span><span class="nx">@nrow</span><span class="p">()</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">this</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">column</span>
    <span class="k">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              
<h2>ItemSet</h2>
<p>A class to that handles the sampling of experimental items</p>

            </div>
            
            <div class="content"><div class="highlight"><pre><span class="nv">exports.ItemSet=</span>
<span class="k">class</span> <span class="nx">ItemSet</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              
<p>itemTable must be of type &#39;DataTable&#39;</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(@itemTable) -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              
<h2>ExpDesign</h2>
<p>A class that represents an experimental design consisting of an array of one or more <strong>blocks</strong>
each consisting of a set of one or more <strong>trials</strong>.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre><span class="nv">exports.ExpDesign =</span>
<span class="k">class</span> <span class="nx">ExpDesign</span>

  <span class="vi">@blocks = </span><span class="mi">1</span>

  <span class="nv">blockTrials: </span><span class="nf">(blocknum) -&gt;</span>
    <span class="nx">@design</span><span class="p">[</span><span class="nx">blocknum</span><span class="p">]</span>

  <span class="nv">ncells: </span><span class="nf">(includeBlock=false) -&gt;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">includeBlock</span><span class="p">)</span>
      <span class="nx">@crossedCells</span><span class="p">.</span><span class="nx">nrow</span><span class="p">()</span> <span class="o">*</span> <span class="nx">@blocks</span>
    <span class="k">else</span>
      <span class="nx">@crossedCells</span><span class="p">.</span><span class="nx">nrow</span><span class="p">()</span>


  <span class="nv">ntrials: </span><span class="nf">(byBlock=false) -&gt;</span>
    <span class="nv">blen = </span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">@design</span><span class="p">,</span> <span class="nf">(x) -&gt;</span> <span class="nx">x</span><span class="p">.</span><span class="nx">nrow</span><span class="p">())</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">byBlock</span><span class="p">)</span>
      <span class="nx">blen</span>
    <span class="k">else</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">blen</span><span class="p">,</span> <span class="nf">(sum, num) -&gt;</span> <span class="nx">sum</span> <span class="o">+</span> <span class="nx">num</span><span class="p">)</span>

  <span class="vi">@validate: </span><span class="nf">(spec) -&gt;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Variables&quot;</span> <span class="k">of</span> <span class="nx">spec</span><span class="p">))</span>
      <span class="k">throw</span> <span class="s">&quot;Variables is undefined&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Structure&quot;</span> <span class="k">of</span> <span class="nx">spec</span><span class="p">))</span>
      <span class="k">throw</span> <span class="s">&quot;Structure is undefined&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Items&quot;</span> <span class="k">of</span> <span class="nx">spec</span><span class="p">))</span>
      <span class="k">throw</span> <span class="s">&quot;Items is undefined&quot;</span>

  <span class="vi">@prepareItems: </span><span class="nf">(itemSpec) -&gt;</span>
    <span class="vi">@items = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">itemSpec</span>
      <span class="nv">values = </span><span class="nx">value</span><span class="p">[</span><span class="s">&quot;values&quot;</span><span class="p">]</span>
      <span class="nv">attributes = </span><span class="nx">value</span><span class="p">[</span><span class="s">&quot;attributes&quot;</span><span class="p">]</span>
      <span class="nv">v = </span><span class="k">new</span> <span class="nx">DataTable</span><span class="p">({</span> <span class="nv">values: </span><span class="nx">values</span><span class="p">})</span>

      <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">attributes</span>
        <span class="nv">v = </span><span class="nx">v</span><span class="p">.</span><span class="nx">bindcol</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>

      <span class="nx">@items</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>


  <span class="nv">constructor: </span><span class="nf">(spec={ }) -&gt;</span>
    <span class="nx">ExpDesign</span><span class="p">.</span><span class="nx">validate</span><span class="p">(</span><span class="nx">spec</span><span class="p">)</span>
    <span class="vi">@variables = </span><span class="nx">spec</span><span class="p">[</span><span class="s">&quot;Variables&quot;</span><span class="p">]</span>

    <span class="vi">@itemSpec = </span><span class="nx">spec</span><span class="p">[</span><span class="s">&quot;Items&quot;</span><span class="p">]</span>

    <span class="nx">ExpDesign</span><span class="p">.</span><span class="nx">prepareItems</span><span class="p">(</span><span class="nx">@itemSpec</span><span class="p">)</span>

    <span class="vi">@structure = </span><span class="nx">spec</span><span class="p">[</span><span class="s">&quot;Structure&quot;</span><span class="p">]</span>

    <span class="vi">@varnames = </span><span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">@variables</span><span class="p">)</span>

    <span class="vi">@crossedVars = </span><span class="p">{}</span>

    <span class="nx">@crossedVars</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="s">&quot;levels&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">@variables</span> <span class="k">when</span> <span class="nx">value</span><span class="p">[</span><span class="s">&quot;crossed&quot;</span><span class="p">]</span> <span class="o">and</span> <span class="nx">value</span><span class="p">[</span><span class="s">&quot;type&quot;</span><span class="p">]</span> <span class="o">is</span> <span class="s">&quot;Factor&quot;</span>

    <span class="vi">@continuousVars = </span><span class="p">{}</span>

    <span class="nx">@continuousVars</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span> <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">@variables</span> <span class="k">when</span> <span class="nx">value</span><span class="p">[</span><span class="s">&quot;type&quot;</span><span class="p">]</span> <span class="o">is</span> <span class="s">&quot;Continuous&quot;</span>

    <span class="vi">@crossedCells = </span><span class="nx">DataTable</span><span class="p">.</span><span class="nx">expand</span><span class="p">(</span><span class="nx">@crossedVars</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">@structure</span><span class="p">[</span><span class="s">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Block&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">@structure</span><span class="p">,</span> <span class="s">&quot;reps_per_block&quot;</span><span class="p">))</span>
        <span class="nx">@structure</span><span class="p">[</span><span class="s">&quot;reps_per_block&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

      <span class="nv">reps = </span><span class="nx">@structure</span><span class="p">[</span><span class="s">&quot;reps_per_block&quot;</span><span class="p">]</span>

      <span class="vi">@blocks = </span><span class="nx">@structure</span><span class="p">[</span><span class="s">&quot;blocks&quot;</span><span class="p">]</span>

      <span class="vi">@design = </span><span class="p">(</span><span class="nx">@crossedCells</span><span class="p">.</span><span class="nx">replicate</span><span class="p">(</span><span class="nx">reps</span><span class="p">)</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="nx">@blocks</span><span class="p">])</span>

</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
